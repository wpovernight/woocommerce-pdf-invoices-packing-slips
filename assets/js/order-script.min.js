jQuery(function(a){function b(b,c=null){b.find(".read-only").is(":visible")?("notes"===c?b.find(".editable-notes :input").attr("disabled",!1):(b.find(".editable").show(),b.find(":input").attr("disabled",!1)),b.find(".read-only").hide(),b.find(".editable-notes").show(),b.closest(".wcpdf-data-fields").find(".wpo-wcpdf-document-buttons").show(),a(".wcpdf-data-fields .woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200,keepAlive:!0}).css("cursor","help"),a(".wcpdf-data-fields .date-picker-field, .date-picker").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0})):(b.find(".read-only").show(),b.find(".editable").hide(),b.find(".editable-notes").hide(),b.find(":input").attr("disabled",!0),b.closest(".wcpdf-data-fields").find(".wpo-wcpdf-document-buttons").hide())}function c(b){let c=b.find("input[name$=\"_number_prefix\"]").val(),d=b.find("input[name$=\"_number_suffix\"]").val(),e=b.find("input[name$=\"_number_padding\"]").val(),f=b.find("input[name$=\"_number_plain\"]").val(),g=b.data("document"),h=b.data("order_id");a.ajax({url:wpo_wcpdf_ajax.ajaxurl,method:"POST",data:{action:"wpo_wcpdf_preview_formatted_number",security:wpo_wcpdf_ajax.nonce,prefix:c,suffix:d,padding:e,plain:f,document:g,order_id:h},success:function(a){if(a.success&&a.data.formatted){let c=b.find(".formatted-number"),d=c.data("current"),e=a.data.formatted;c.val(e),d===e?c.removeClass("changed"):c.addClass("changed")}},error:function(a,c,d){console.error("AJAX error:",c,d),b.find(".formatted-number").value(wpo_wcpdf_ajax.error_loading_number_preview)}})}function d(){let b=[];return a(".wcpdf-data-fields").each(function(){"yes"===a(this).attr("data-is_pending")&&b.push(a(this).data("document"))}),b}a("#doaction, #doaction2").on("click",function(b){let c=a(this).attr("id").substr(2),d=a("select[name=\""+c+"\"]").val();if(-1!==a.inArray(d,wpo_wcpdf_ajax.bulk_actions)){b.preventDefault();let c=d,e=[],f=!1;if(-1!=d.indexOf("ubl")&&(c=c.replace("_ubl",""),f=!0),a("tbody th.check-column input[type=\"checkbox\"]:checked").each(function(){e.push(a(this).val())}),!e.length)return void alert(wpo_wcpdf_ajax.select_orders);let g="",h="";if(g=-1==wpo_wcpdf_ajax.ajaxurl.indexOf("?")?wpo_wcpdf_ajax.ajaxurl+"?action=generate_wpo_wcpdf&document_type="+c+"&bulk&_wpnonce="+wpo_wcpdf_ajax.nonce:wpo_wcpdf_ajax.ajaxurl+"&action=generate_wpo_wcpdf&document_type="+c+"&bulk&_wpnonce="+wpo_wcpdf_ajax.nonce,f)a.each(e,function(a,b){h=g+"&order_ids="+b+"&output=ubl",window.open(h,"_blank")});else{let a=e.join("x");h=g+"&order_ids="+a,window.open(h,"_blank")}}}),wpo_wcpdf_ajax.sticky_document_data_metabox&&a("#wpo_wcpdf-data-input-box").insertAfter("#woocommerce-order-data"),a("#wpo_wcpdf-data-input-box").on("click",".wpo-wcpdf-set-date-number, .wpo-wcpdf-edit-date-number, .wpo-wcpdf-edit-document-notes",function(){let c=a(this).closest(".wcpdf-data-fields-section");0==c.length&&(c=a(this).closest(".wcpdf-data-fields"));let d=a(this).data("edit");b(c,d)}),a("#wpo_wcpdf-data-input-box").on("click",".wpo-wcpdf-cancel",function(){let c=a(this).closest(".wcpdf-data-fields");b(c)}),a("#wpo_wcpdf-data-input-box").on("click",".wpo-wcpdf-save-document, .wpo-wcpdf-regenerate-document, .wpo-wcpdf-delete-document",function(c){c.preventDefault();let d=a(this).closest(".wcpdf-data-fields"),e=a(this).data("action"),f=a(this).data("nonce"),g=d.data(),h=d.find(":input:visible:not(:disabled)").serialize();if("regenerate"===e){if(!1===window.confirm(wpo_wcpdf_ajax.confirm_regenerate))return;d.find(".wpo-wcpdf-regenerate-document").addClass("wcpdf-regenerate-spin")}else if("delete"===e){if(!1===window.confirm(wpo_wcpdf_ajax.confirm_delete))return;d.find(".wpo-wcpdf-regenerate-document").hide()}const i=a(this).closest("#wpo_wcpdf-data-input-box").find(".notice");i.length&&i.remove(),d.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajax({url:wpo_wcpdf_ajax.ajaxurl,data:{action:"wpo_wcpdf_"+e+"_document",security:f,form_data:h,order_id:g.order_id,document_type:g.document,action_type:e,wpcdf_document_data_notice:e+"d"},type:"POST",context:d,success:function(c){d.closest("#wpo_wcpdf-data-input-box").load(document.URL+" #wpo_wcpdf-data-input-box .postbox-header, #wpo_wcpdf-data-input-box .inside",function(){b(d);const f=c.success?"success":"error",h=a(this).find(".wcpdf-data-fields[data-document=\""+g.document+"\"][data-order_id=\""+g.order_id+"\"]");h.length&&h.before("<div class=\"notice notice-"+f+" inline\" style=\"margin:0 10px 10px 10px;\"><p>"+c.data.message+"</p></div>"),"regenerate"===e&&(d.find(".wpo-wcpdf-regenerate-document").removeClass("wcpdf-regenerate-spin"),b(d)),d.unblock()})}})}),a("#wpo_wcpdf-data-input-box").on("click",".view-more, .hide-details",function(b){b.preventDefault(),a(this).hide(),a(".pdf-more-details").slideToggle("slow"),a(this).hasClass("view-more")?a(".hide-details").show():a(".view-more").show()});let e;a(document).on("input",".wcpdf-data-fields input",function(){const b=a(this).closest(".wcpdf-data-fields");clearTimeout(e),e=setTimeout(()=>{c(b)},300)});let f=d(),g=0;const h=3e3,i=function(){0>=f.length||(a.ajax({url:wpo_wcpdf_ajax.ajaxurl,type:"POST",data:{action:"wpo_fetch_document_data",security:wpo_wcpdf_ajax.nonce,document_types:f,order_id:woocommerce_admin_meta_boxes.post_id},success:function(b){a.each(b.data,function(b,c){a(".wcpdf-data-fields[data-document=\""+b+"\"]").replaceWith(c)}),f=d()},error:function(a){console.log(a.message)}}),g++,g<3&&setTimeout(i,h))};setTimeout(i,h)});