(function(){function a(...a){p&&console.log("[WPO IPS Peppol]",...a)}function b(a){const b=document.querySelector(a);return b?((b.value||"")+"").trim():""}function c(){try{const a=window.wp?.data?.select?.("wc/store/cart");if(a&&"function"==typeof a.getCustomerData){const b=a.getCustomerData()||{},c=b.billingAddress?.country||b.billing_address?.country||b.customer?.billingAddress?.country||b.customer?.billing_address?.country;if(c)return(c+"").trim()}}catch(a){}return b(q)}function d(a){const b=((a||"")+"").toUpperCase();return o.includes(b)}function e(a){return((a||"")+"").replace(/\s+/g,"").toUpperCase().trim()}function f(a,b){if(!a)return!1;const c=(b??"")+"";if((a.value??"")+""===c)return!0;a.value=c,a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0}));const d=a.closest(".wc-block-components-text-input");return d&&c?d.classList.add("is-active"):d&&!c&&d.classList.remove("is-active"),!0}function g(a,b){a&&requestAnimationFrame(()=>{f(a,b),requestAnimationFrame(()=>f(a,b))})}function h(a,b){const c=window.wp?.apiFetch;return c?c({path:u,method:"POST",data:{billing_country:((a||"")+"").toUpperCase(),vat:(b||"")+""}}):Promise.resolve(null)}function i(a,b,c){if(!a)return;let d=a.querySelector(".wpo-ips-override");return c?d?d:(d=document.createElement("a"),d.href="#",d.className="wpo-ips-override",d.textContent=n.override_link_text||"Unlock",d.addEventListener("click",a=>{a.preventDefault();const c=b?(b.value||"")+"":"";x=!0,y=c,l("override-click"),b&&(c&&g(b,c),b.focus())}),a.appendChild(d),d):void(d&&d.remove())}function j(a,b,c){a.readOnly=c,a.style.pointerEvents=c?"none":"",a.setAttribute("aria-disabled",c?"true":"false"),a.classList.toggle("wpo-is-locked",c),b&&b.classList.toggle("wpo-ips-locked-wrap",c)}function k(a){function b(){const b=(a.value||"")+"";b&&(y=b)}!a||a.__wpoPeppolManualBound||(a.__wpoPeppolManualBound=!0,a.addEventListener("input",()=>{x&&(y=(a.value||"")+"")}),a.addEventListener("pointerdown",()=>{x&&b()}),a.addEventListener("mousedown",()=>{x&&b()}),a.addEventListener("focus",()=>{x&&y&&g(a,y)}),a.addEventListener("blur",()=>{x&&(b(),y&&g(a,y))}))}function l(g="unknown"){D=!1;const l=document.querySelector(s),m=document.querySelector(t);if(!m)return;k(m);const n=c().toUpperCase(),o=b(r);(n!==A||o!==z)&&(x=!1,y="",A=n,z=o,w=null);const p=d(n)&&""!==o,q=p&&!x;if(p&&!x&&""!==o){const a=e(o),b=n+"|"+a;w&&w.key===b?w.value&&f(m,w.value):(v&&clearTimeout(v),v=setTimeout(()=>{h(n,a).then(a=>{const c=((a?.id||"")+"").trim();w={key:b,value:c},c&&f(m,c)}).catch(()=>{})},250))}q===B&&m===C||(i(l,m,q),j(m,l,q),B=q,C=m,a("lock state applied",{source:g,country:n,vatValue:o,locked:q,manualOverride:x,lastValue:w?w.value:"",manualOverrideValue:y}))}function m(a){D||(D=!0,requestAnimationFrame(()=>l(a)))}const n=window.wpoIpsPeppol||{},o=Array.isArray(n.countries)?n.countries.map(a=>(a+"").toUpperCase()):[],p=!!n.debug,q=n.billing_country_selector,r=n.vat_field_selector,s=n.peppol_input_wrapper_selector,t=s+" input",u=n.peppol_autofill_endpoint_route;let v=null,w=null,x=!1,y="",z=null,A=null,B=null,C=null,D=!1;const E=document.querySelector("#order-fields")||document.querySelector(".wc-block-checkout")||document.documentElement;new MutationObserver(()=>m("mutation")).observe(E,{childList:!0,subtree:!0}),document.addEventListener("input",a=>{(a.target?.matches(q)||a.target?.matches(r))&&m("input")}),window.wp?.data?.subscribe&&window.wp.data.subscribe(()=>m("store")),m("init")})();