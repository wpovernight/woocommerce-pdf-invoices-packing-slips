(function(){function a(...a){p&&console.log("[WPO IPS Peppol]",...a)}function b(a){const b=document.querySelector(a);return b?((b.value||"")+"").trim():""}function c(){try{const a=window.wp?.data?.select?.("wc/store/cart");if(a&&"function"==typeof a.getCustomerData){const b=a.getCustomerData()||{},c=b.billingAddress?.country||b.billing_address?.country||b.customer?.billingAddress?.country||b.customer?.billing_address?.country;if(c)return(c+"").trim()}}catch(a){}return b(q)}function d(a){const b=((a||"")+"").toUpperCase();return o.includes(b)}function e(a){return((a||"")+"").replace(/\s+/g,"").toUpperCase().trim()}function f(a,b){if(!a)return!1;const c=(b??"")+"";if((a.value??"")+""===c)return!0;a.value=c,a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0}));const d=a.closest(".wc-block-components-text-input");return d&&c?d.classList.add("is-active"):d&&!c&&d.classList.remove("is-active"),!0}function g(a,b){a&&requestAnimationFrame(()=>{f(a,b),requestAnimationFrame(()=>f(a,b))})}function h(a,b){const c=window.wp?.apiFetch;return c?c({path:u,method:"POST",data:{billing_country:((a||"")+"").toUpperCase(),vat:(b||"")+""}}):Promise.resolve(null)}function i(){if(!document.getElementById("wpo-ips-peppol-lock-styles")){const a=document.createElement("style");a.id="wpo-ips-peppol-lock-styles",a.textContent=`
			/* Locked look */
			.wpo-is-locked {
				opacity: 0.75;
				cursor: not-allowed;
			}

			/* Make wrapper look disabled (Blocks uses wrapper divs) */
			.wpo-ips-locked-wrap {
				opacity: 0.75;
			}
			.wpo-ips-locked-wrap input {
				background: rgba(0,0,0,0.04);
			}

			/* Override link */
			.wpo-ips-override {
				display: block;
				margin-top: 6px;
				font-size: 12px;
				text-decoration: underline;
				cursor: pointer;
				user-select: none;
			}
			.wpo-ips-override:hover {
				text-decoration: none;
			}
		`,document.head.appendChild(a)}}function j(a,b,c){if(!a)return;let d=a.querySelector(".wpo-ips-override");return c?d?d:(d=document.createElement("a"),d.href="#",d.className="wpo-ips-override",d.textContent=n.override_link_text||"Unlock",d.addEventListener("click",a=>{a.preventDefault();const c=b?(b.value||"")+"":"";x=!0,l("override-click"),b&&(c&&g(b,c),b.focus())}),a.appendChild(d),d):void(d&&d.remove())}function k(a,b,c){a.readOnly=c,a.style.pointerEvents=c?"none":"",a.setAttribute("aria-disabled",c?"true":"false"),a.classList.toggle("wpo-is-locked",c),b&&b.classList.toggle("wpo-ips-locked-wrap",c)}function l(g="unknown"){C=!1,i();const l=document.querySelector(s),m=document.querySelector(t);if(!m)return;const n=c().toUpperCase(),o=b(r);(n!==z||o!==y)&&(x=!1,z=n,y=o,w=null);const p=d(n)&&""!==o,q=p&&!x;if(p&&!x&&""!==o){const a=e(o),b=n+"|"+a;w&&w.key===b?w.value&&f(m,w.value):(v&&clearTimeout(v),v=setTimeout(()=>{h(n,a).then(a=>{const c=((a?.value||"")+"").trim();w={key:b,value:c},c&&f(m,c)}).catch(()=>{})},250))}q===A&&m===B||(j(l,m,q),k(m,l,q),A=q,B=m,a("lock state applied",{source:g,country:n,vatValue:o,locked:q,manualOverride:x,lastValue:w?w.value:""}))}function m(a){C||(C=!0,requestAnimationFrame(()=>l(a)))}const n=window.wpoIpsPeppol||{},o=Array.isArray(n.countries)?n.countries.map(a=>(a+"").toUpperCase()):[],p=!!n.debug,q="#billing-country, select[name=\"billing_country\"], .wc-block-components-address-form__country select, .wc-block-components-country-input select",r=n.vat_field_selector,s=".wc-block-components-address-form__wpo-ips-edi-peppol-endpoint-id",t=s+" input",u="/wpo-ips/v1/peppol-endpoint";let v=null,w=null,x=!1,y=null,z=null,A=null,B=null,C=!1;const D=document.querySelector("#order-fields")||document.querySelector(".wc-block-checkout")||document.documentElement;new MutationObserver(()=>m("mutation")).observe(D,{childList:!0,subtree:!0}),document.addEventListener("input",a=>{(a.target?.matches(q)||a.target?.matches(r))&&m("input")}),window.wp?.data?.subscribe&&window.wp.data.subscribe(()=>m("store")),m("init")})();