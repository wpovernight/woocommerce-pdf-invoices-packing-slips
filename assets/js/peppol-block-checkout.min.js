(function(){function a(...a){q&&console.log("[WPO IPS Peppol]",...a)}function b(a){const b=document.querySelector(a);return b?((b.value||"")+"").trim():""}function c(){try{const a=window.wp?.data?.select?.("wc/store/cart");if(a&&"function"==typeof a.getCustomerData){const b=a.getCustomerData()||{},c=b.billingAddress?.country||b.billing_address?.country||b.customer?.billingAddress?.country||b.customer?.billing_address?.country;if(c)return(c+"").trim()}}catch(a){}return b(r)}function d(a){const b=((a||"")+"").toUpperCase();return p.includes(b)}function e(a){return((a||"")+"").replace(/\s+/g,"").toUpperCase().trim()}function f(a,b){if(!a)return!1;const c=(b??"")+"";if((a.value??"")+""===c)return!0;a.value=c,a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0}));const d=a.closest(".wc-block-components-text-input");return d&&c?d.classList.add("is-active"):d&&!c&&d.classList.remove("is-active"),!0}function g(a,b){a&&requestAnimationFrame(()=>{f(a,b),requestAnimationFrame(()=>f(a,b))})}function h(a,b){const c=window.wp?.apiFetch;return c?c({path:v,method:"POST",data:{billing_country:((a||"")+"").toUpperCase(),vat:(b||"")+""}}):Promise.resolve(null)}function i(){if(!document.getElementById("wpo-ips-peppol-lock-styles")){const a=document.createElement("style");a.id="wpo-ips-peppol-lock-styles",a.textContent=`
			/* Locked look */
			.wpo-is-locked {
				opacity: 0.75;
				cursor: not-allowed;
			}

			/* Make wrapper look disabled (Blocks uses wrapper divs) */
			.wpo-ips-locked-wrap {
				opacity: 0.75;
			}
			.wpo-ips-locked-wrap input {
				background: rgba(0,0,0,0.04);
			}

			/* Override link */
			.wpo-ips-override {
				display: block;
				margin-top: 6px;
				font-size: 12px;
				text-decoration: underline;
				cursor: pointer;
				user-select: none;
			}
			.wpo-ips-override:hover {
				text-decoration: none;
			}
		`,document.head.appendChild(a)}}function j(a,b,c){if(!a)return;let d=a.querySelector(".wpo-ips-override");return c?d?d:(d=document.createElement("a"),d.href="#",d.className="wpo-ips-override",d.textContent=o.override_link_text||"Unlock",d.addEventListener("click",a=>{a.preventDefault();const c=b?(b.value||"")+"":"";y=!0,z=c,m("override-click"),b&&(c&&g(b,c),b.focus())}),a.appendChild(d),d):void(d&&d.remove())}function k(a,b,c){a.readOnly=c,a.style.pointerEvents=c?"none":"",a.setAttribute("aria-disabled",c?"true":"false"),a.classList.toggle("wpo-is-locked",c),b&&b.classList.toggle("wpo-ips-locked-wrap",c)}function l(a){function b(){const b=(a.value||"")+"";b&&(z=b)}!a||a.__wpoPeppolManualBound||(a.__wpoPeppolManualBound=!0,a.addEventListener("input",()=>{y&&(z=(a.value||"")+"")}),a.addEventListener("pointerdown",()=>{y&&b()}),a.addEventListener("mousedown",()=>{y&&b()}),a.addEventListener("focus",()=>{y&&z&&g(a,z)}),a.addEventListener("blur",()=>{y&&(b(),z&&g(a,z))}))}function m(g="unknown"){E=!1,i();const m=document.querySelector(t),n=document.querySelector(u);if(!n)return;l(n);const o=c().toUpperCase(),p=b(s);(o!==B||p!==A)&&(y=!1,z="",B=o,A=p,x=null);const q=d(o)&&""!==p,r=q&&!y;if(q&&!y&&""!==p){const a=e(p),b=o+"|"+a;x&&x.key===b?x.value&&f(n,x.value):(w&&clearTimeout(w),w=setTimeout(()=>{h(o,a).then(a=>{const c=((a?.value||"")+"").trim();x={key:b,value:c},c&&f(n,c)}).catch(()=>{})},250))}r===C&&n===D||(j(m,n,r),k(n,m,r),C=r,D=n,a("lock state applied",{source:g,country:o,vatValue:p,locked:r,manualOverride:y,lastValue:x?x.value:"",manualOverrideValue:z}))}function n(a){E||(E=!0,requestAnimationFrame(()=>m(a)))}const o=window.wpoIpsPeppol||{},p=Array.isArray(o.countries)?o.countries.map(a=>(a+"").toUpperCase()):[],q=!!o.debug,r="#billing-country, select[name=\"billing_country\"], .wc-block-components-address-form__country select, .wc-block-components-country-input select",s=o.vat_field_selector,t=".wc-block-components-address-form__wpo-ips-edi-peppol-endpoint-id",u=t+" input",v="/wpo-ips/v1/peppol-endpoint";let w=null,x=null,y=!1,z="",A=null,B=null,C=null,D=null,E=!1;const F=document.querySelector("#order-fields")||document.querySelector(".wc-block-checkout")||document.documentElement;new MutationObserver(()=>n("mutation")).observe(F,{childList:!0,subtree:!0}),document.addEventListener("input",a=>{(a.target?.matches(r)||a.target?.matches(s))&&n("input")}),window.wp?.data?.subscribe&&window.wp.data.subscribe(()=>n("store")),n("init")})();