jQuery(function(a){function b(){n=x.val(),o=y.val(),p=z.val(),q=A.val(),r=B.serialize()}function c(){x.val("").trigger("change")}function d(){!1==v.attr("data-preview-states-lock")&&(1200>=a(this).width()&&(1200<u||a(this).width()==u)?"full"==v.attr("data-preview-state")?(v.find(".preview-document").show(),v.find(".sidebar").hide(),v.find(".slide-left").hide(),v.find(".slide-right").show(),v.attr("data-preview-states",2),v.attr("data-preview-state","full"),v.attr("data-from-preview-state","")):(v.find(".preview-document").hide(),v.find(".sidebar").show(),v.find(".slide-left").show(),v.find(".slide-right").hide(),v.attr("data-preview-states",2),v.attr("data-preview-state","closed"),v.attr("data-from-preview-state","")):1200<a(this).width()&&(1200>=u||a(this).width()==u)&&("full"==v.attr("data-preview-state")?(v.find(".preview-document").show(),v.find(".sidebar").hide(),v.find(".slide-left").hide(),v.find(".slide-right").show(),v.attr("data-preview-states",3),v.attr("data-preview-state","full"),v.attr("data-from-preview-state","sidebar"),v.addClass("static")):"closed"==v.attr("data-preview-state")&&a(this).width()!==u?(v.find(".preview-document").hide(),v.find(".sidebar").show(),v.find(".slide-left").show(),v.find(".slide-right").hide(),v.attr("data-preview-states",3),v.attr("data-preview-state","closed"),v.attr("data-from-preview-state",""),v.removeClass("static")):(v.find(".preview-document, .sidebar").show(),v.find(".slide-left, .slide-right").show(),v.attr("data-preview-states",3),v.attr("data-preview-state","sidebar"),v.attr("data-from-preview-state",""),v.removeClass("static")))),u=a(this).width()}function e(a){window.scrollTo(0,0);let b=a;setTimeout(function(){b.addClass("static")},300)}function f(b,c){"shop_address_country"===b.target.id&&g(a(b.target)),h();let d=a(b.target);if(!j(d.attr("name"))){if(d.hasClass("remove-requirement")||"disable_for"==d.attr("id"))return;if(-1!==a.inArray(b.type,["keyup","paste"])){if(d.is("input[type=\"checkbox\"], select"))return;c="keyup"==b.type?1e3:0}i(c)}}function g(b){const c=b.val(),d=b.closest("form"),e=b.attr("name").match(/\[shop_address_country]\[(.*?)\]/),f=e?e[1]:"default",g=d.find(`select[name="wpo_wcpdf_settings_general[shop_address_state][${f}]"]`),h=g.closest(".wpo-wcpdf-input-wrapper").find("#shop_address_state_action");return g.empty().prop("disabled",!0),h.prop("disabled",!0),g.append(a("<option>",{value:"",text:wpo_wcpdf_admin.shop_country_changed_messages.loading})),a.ajax({url:wpo_wcpdf_admin.ajaxurl,type:"POST",dataType:"json",data:{action:"wcpdf_get_country_states",country:c,security:wpo_wcpdf_admin.nonce},success:function(b){g.empty();const c=b.data?.states,d=b.data?.selected;b.success&&c&&0<Object.keys(c).length?(a.each(c,function(b,c){g.append(a("<option>",{value:b,text:c,selected:b===d}))}),g.prop("disabled",!1),h.prop("disabled",!1)):g.append(a("<option>",{value:"",text:wpo_wcpdf_admin.shop_country_changed_messages.empty})),i()},error:function(){g.empty().append(a("<option>",{value:"",text:wpo_wcpdf_admin.shop_country_changed_messages.error})),i()}})}function h(b){a(".preview-data-wrapper .save-settings p").css("margin-right","0")}function i(c=0){$previewStates=a("#wpo-wcpdf-preview-wrapper").data("preview-states");"undefined"===$previewStates||1===$previewStates||(c="number"==typeof c?c:0,b(),clearTimeout(s),s=setTimeout(function(){k()},c))}function j(b){let c=!1;if(!b)return c;let d=b.includes("[")?b.match(/\[(.*?)\]/)[1]:b;return-1!==a.inArray(d,wpo_wcpdf_admin.preview_excluded_settings)&&(c=!0),c}function k(){console.log("Loading preview...");let b=wpo_wcpdf_admin.pdfjs_worker,c="preview-canvas",d={action:"wpo_wcpdf_preview",security:q,order_id:n,document_type:o,output_format:p,data:r};w.children(".notice").remove(),w.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),C=a.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:d,beforeSend:function(a,b){null!=C&&C.abort()},success:function(d,e,f){if(d.data.error)a("#"+c).remove(),w.append("<div class=\"notice notice-error inline\"><p>"+d.data.error+"</p></div>");else if(d.data.preview_data&&d.data.output_format)switch(a("#"+c).remove(),d.data.output_format){default:case"pdf":w.append("<canvas id=\""+c+"\" style=\"width:100%;\"></canvas>"),l(b,c,d.data.preview_data);break;case"ubl":let a=d.data.preview_data,e=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\n/g,"<br />");w.html("<div id=\"preview-ubl\">"+e+"</div>")}w.unblock()},error:function(b,d,e){if("abort"!=d){let d=b.status+": "+b.statusText;a("#"+c).remove(),w.append("<div class=\"notice notice-error inline\"><p>"+d+"</p></div>"),w.unblock()}}})}function l(a,b,c){c=window.atob(c),pdfjsLib.GlobalWorkerOptions.workerSrc=a;let d=pdfjsLib.getDocument({data:c});d.promise.then(function(a){let c=1;a.getPage(1).then(function(a){let c=2,d=a.getViewport({scale:2}),e=document.getElementById(b),f=e.getContext("2d");e.height=d.height,e.width=d.width;let g={canvasContext:f,viewport:d},h=a.render(g);h.promise.then(function(){})})},function(a){console.error(a)})}function m(b){let c=b.closest(".preview-data").find("#preview-order-search-results"),d=b.val(),e=b.data("nonce"),f="wpo_wcpdf_preview_order_search",g={security:e,action:f,search:d,document_type:o};c.parent().find("img.preview-order-search-clear").hide(),c.children(".error").remove(),c.children("a").remove(),c.hide(),a.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:g,success:function(d){d.data&&(d.data.error?(c.append("<span class=\"error\">"+d.data.error+"</span>"),c.show()):a.each(d.data,function(a,b){let d="<a data-order_id=\""+a+"\"><span class=\"order-number\">#"+b.order_number+"</span> - "+b.billing_first_name+" "+b.billing_last_name;0<b.billing_company.length&&(d=d+", "+b.billing_company);let e="<br><span class=\"date\">"+b.date_created+"</span><span class=\"total\">"+b.total+"</span></a>";c.append(d+e),c.show()})),b.removeClass("ajax-waiting"),b.closest("div").find("img.preview-order-search-clear").show()}})}a(".wcpdf-extensions .more").hide(),a(".wcpdf-extensions > li").on("click",function(b){a(this).toggleClass("expanded"),a(this).find(".more").slideToggle()}),a(".edit-next-number").on("click",function(b){a(this).hide(),a(this).siblings("input").prop("disabled",!1),a(this).siblings(".save-next-number.button").show()}),a(".save-next-number").on("click",function(b){$input=a(this).siblings("input"),$input.addClass("ajax-waiting");let c=$input.val();if(0<c.length&&2147483647<c)return alert(wpo_wcpdf_admin.mysql_int_size_limit),void $input.removeClass("ajax-waiting");let d={security:$input.data("nonce"),action:"wpo_wcpdf_set_next_number",store:$input.data("store"),number:c};xhr=a.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:d,success:function(a){$input.removeClass("ajax-waiting"),$input.siblings(".edit-next-number").show(),$input.prop("disabled","disabled"),$input.siblings(".save-next-number.button").hide()}})}),a("[name='wpo_wcpdf_documents_settings_invoice[display_number]']").on("change",function(b){"order_number"==a(this).val()?(a(this).closest("td").find(".description").slideDown(),a(this).closest("tr").nextAll("tr").has("input#next_invoice_number").first().hide()):(a(this).closest("td").find(".description").hide(),a(this).closest("tr").nextAll("tr").has("input#next_invoice_number").first().show())}).trigger("change"),a("[name='wpo_wcpdf_documents_settings_invoice_ubl[ubl_format]']").on("change",function(b){let c=a(this).closest("form").find("[name='wpo_wcpdf_documents_settings_invoice_ubl[include_encrypted_pdf]']");"ubl_2_1"===a(this).val()?c.prop("disabled",!1):c.prop("checked",!1).prop("disabled",!0)}).trigger("change"),a(".wcpdf_document_settings_sections > h2").on("click",function(){a(this).parent().find("ul").toggleClass("active")}),a.each(wpo_wcpdf_admin.pointers,function(b,c){a(c.target).pointer({content:c.content,position:{edge:c.position.edge,align:c.position.align},pointerClass:c.pointer_class,pointerWidth:c.pointer_width,close:function(){jQuery.post(wpo_wcpdf_admin.ajaxurl,{pointer:b,action:"dismiss-wp-pointer"})}}),-1===a.inArray(b,wpo_wcpdf_admin.dismissed_pointers.split(","))&&a(c.target).pointer("open")}),a(".woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),a("#wpo-wcpdf-preview-wrapper #due_date").on("change",function(){const b=a("#wpo-wcpdf-preview-wrapper #due_date"),c=a("#wpo-wcpdf-preview-wrapper #due_date_days");b.is(":checked")?c.prop("disabled",!1):c.prop("disabled",!0)}).trigger("change");let n,o,p,q,r,s,t,u,v=a("#wpo-wcpdf-preview-wrapper"),w=a("#wpo-wcpdf-preview-wrapper .preview"),x=a("#wpo-wcpdf-preview-wrapper input[name=\"order_id\"]"),y=a("#wpo-wcpdf-preview-wrapper input[name=\"document_type\"]"),z=a("#wpo-wcpdf-preview-wrapper input[name=\"output_format\"]"),A=a("#wpo-wcpdf-preview-wrapper input[name=\"nonce\"]"),B=a("#wpo-wcpdf-settings"),C=null;(function a(){y.val(y.data("default")).trigger("change")})(),c(),b(),u=a(window).width(),d(),a(window).on("resize",d),a(".slide-left").on("click",function(){let a=v.attr("data-preview-states"),b=v.attr("data-preview-state");v.find(".preview-data-wrapper ul").removeClass("active"),3==a?"closed"==b?(v.find(".preview-document").show(),v.find(".slide-right").show(),v.attr("data-preview-state","sidebar"),v.attr("data-from-preview-state","closed")):(v.find(".slide-left").hide(),v.find(".sidebar").delay(300).hide(0),v.attr("data-preview-state","full"),v.attr("data-from-preview-state","sidebar"),e(v)):(v.find(".preview-document").show(),v.find(".slide-left").hide(),v.find(".slide-right").show(),v.attr("data-preview-state","full"),v.attr("data-from-preview-state","closed"),e(v))}),a(".slide-right").on("click",function(){let a=v.attr("data-preview-states"),b=v.attr("data-preview-state");v.find(".preview-data-wrapper ul").removeClass("active"),3==a?"full"==b?(v.find(".slide-left").delay(400).show(0),v.find(".sidebar").show(),v.attr("data-preview-state","sidebar"),v.attr("data-from-preview-state","full")):(v.find(".preview-document").hide(300),v.find(".slide-right").hide(),v.attr("data-preview-state","closed"),v.attr("data-from-preview-state","sidebar")):(v.find(".preview-document").hide(300),v.find(".slide-left").show(),v.find(".slide-right").hide(),v.attr("data-preview-state","closed"),v.attr("data-from-preview-state","full")),v.removeClass("static")}),a(".preview-document .preview-data p").on("click",function(){let b=a(this).closest(".preview-data");b.siblings(".preview-data").find("ul").removeClass("active"),b.find("ul").toggleClass("active")}),a(".preview-document .preview-data ul > li").on("click",function(){let b=a(this).closest(".preview-data");b.find("ul").toggleClass("active"),a(this).hasClass("order-search")?(b.find("p.last-order").hide(),b.find("input[name=\"preview-order-search\"]").addClass("active"),b.find("p.order-search").show().find(".order-search-label").text(a(this).text())):(b.find("p.last-order").show(),b.find("p.order-search").hide(),b.find("input[name=\"preview-order-search\"]").removeClass("active").val(""),b.find("#preview-order-search-results").hide(),b.find("img.preview-order-search-clear").hide(),c(),i())}),i(),a(document).on("wpo-wcpdf-settings-changed",function(a,b){h(),i(b)}),a(document).on("wpo-wcpdf-refresh-preview wpo_wcpdf_refresh_preview",function(a,b){i(b)}),a(document).on("click","#preview-order-search-results a",function(b){b.preventDefault(),a(".preview-document .order-search-label").text("#"+a(this).data("order_id")),x.val(a(this).data("order_id")).trigger("change"),a(this).closest("div").hide(),a(this).closest("div").children("a").remove(),i()}),a(document).on("keyup paste","#wpo-wcpdf-settings input, #wpo-wcpdf-settings textarea",f),a(document).on("change","#wpo-wcpdf-settings input[type=\"checkbox\"], #wpo-wcpdf-settings input[type=\"radio\"], #wpo-wcpdf-settings select",function(a){"shop_address_country"!==a.target.id&&a.isTrigger||f(a)}),a(document).on("select2:select select2:unselect","#wpo-wcpdf-settings select.wc-enhanced-select",f),a(document.body).on("wpo-wcpdf-media-upload-setting-updated",f),a(document).on("click",".wpo_remove_image_button, #wpo-wcpdf-settings .remove-requirement",f),0<a("#wpo_wcpdf_settings_general-shop_address_country-translations").length&&a("#wpo-wcpdf-settings select[name^=\"wpo_wcpdf_settings_general[shop_address_country]\"]").each(function(){const b=a(this);b.val()&&g(b)}),a(document.body).on("click",".preview-data-wrapper .save-settings p input",function(b){a("#wpo-wcpdf-settings input#submit").trigger("click")}),a(document).on("click","img.preview-order-search-clear",function(b){b.preventDefault(),a(this).closest("div").find("input#preview-order-search").val(""),a(this).closest(".preview-data").find("#preview-order-search-results").children("a").remove(),a(this).closest(".preview-data").find("#preview-order-search-results").children(".error").remove(),a(this).closest(".preview-data").find("#preview-order-search-results").hide(),a(this).hide()}),a("#wpo-wcpdf-preview-wrapper ul.preview-data-option-list li").on("click",function(){let b=a(this).closest("ul").data("input-name"),c=a("#wpo-wcpdf-preview-wrapper :input[name="+b+"]");c.val(a(this).data("value")).trigger("change")}),y.on("change",function(){let b=a(this).val();if(b.length){let c=a(this).attr("name"),d=a("#wpo-wcpdf-preview-wrapper ul.preview-data-option-list[data-input-name="+c+"]"),e=d.find("li[data-value="+b+"]");d.parent().find(".current-label").text(e.text()),i()}}).trigger("change"),x.on("change",function(){i()}).trigger("change"),a("#preview-order-search").on("keyup paste",function(c){let d=a(this);d.addClass("ajax-waiting");let e="keyup"==c.type?1e3:0;b(),clearTimeout(t),t=setTimeout(function(){m(d)},e)}),function b(){function c(b){const c=a(b),d=c.parent(".settings_category").attr("id"),e=c.next(".form-table"),g=!e.is(":visible");c.toggleClass("active",g).attr("aria-expanded",g),e.stop(!0,!1).slideToggle({duration:300,easing:"swing",complete:function(){const b=a(this).is(":visible");a(this).attr("aria-hidden",b?"false":"true"),d&&localStorage.setItem(`wcpdf_${f}_settings_accordion_state_${d}`,b)}})}const d=new URLSearchParams(window.location.search),e=["general","documents","debug"],f=d.get("tab")||"general";if(!e.includes(f))return;const g={general:"display",documents:"general",debug:"filesystem_access"},h=a(".settings_category h2");0===h.length||(h.each(function(b){const c=a(this),d=c.next(".form-table"),e=c.parent(".settings_category"),g=e.attr("id")||c.attr("id")||`wcpdf_${f}_section_${b}`;c.attr("id")||c.attr("id",`${g}_header`);const h=c.attr("id"),i=`${g}_panel`;c.attr({role:"button",tabindex:0,"aria-controls":i}),d.attr({id:i,role:"region","aria-labelledby":h})}),h.each(function(b){const c=a(this),d=c.parent(".settings_category"),e=d.attr("id")||`wcpdf_${f}_section_${b}`,h=c.next(".form-table"),i=localStorage.getItem(`wcpdf_${f}_settings_accordion_state_${e}`);let j=!1;null===i?g[f]&&e===g[f]&&(j=!0):j="true"===i,j?(c.addClass("active").attr("aria-expanded",!0),h.show().attr("aria-hidden","false")):(c.removeClass("active").attr("aria-expanded",!1),h.hide().attr("aria-hidden","true"))}),h.off("click").on("click",function(){c(this)}),h.off("keydown").on("keydown",function(a){("Enter"===a.key||" "===a.key)&&(a.preventDefault(),c(this))}))}(),a("#wpo-wcpdf-settings .sync-address").on("click",function(b){b.preventDefault();const c=a(this),d=a(this).closest("form"),e=c.find("span.dashicons"),f=c.closest(".wpo-wcpdf-input-wrapper").find(".sync-tooltip");let h=c.closest(".wpo-wcpdf-input-wrapper").find("input");0===h.length&&(h=c.closest(".wpo-wcpdf-input-wrapper").find("select")),e.toggleClass("rotate"),a.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:{action:"wpo_wcpdf_sync_address",security:wpo_wcpdf_admin.nonce,address_field:h.attr("id")},success:function(a){if(a.success&&a.data.value&&""!==a.data.value.trim()){if("shop_address_country"===h.attr("id")){const b=a.data.value.split(":");h.val(b[0]),g(h).done(function(){const a=h.attr("name").match(/\[([^\]]+)\]/g),c=a?a[a.length-1].replace(/[\[\]]/g,""):"default",e=d.find(`select[name="wpo_wcpdf_settings_general[shop_address_state][${c}]"]`);0!==e.length&&e.val(b[1])})}else h.val(a.data.value);i()}else!a.success&&a.data.message&&""!==a.data.message.trim()&&(f.text(a.data.message).addClass("visible"),setTimeout(function(){f.removeClass("visible")},3e3))},complete:function(){e.toggleClass("rotate")}})})});